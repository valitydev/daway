# Перевод таблиц в режим партиционирвания

1. Перед выполнением всех скриптов необходимо сделать бэкап целевой таблицы.
2. В рамках перехода существующих крупных таблиц в режим работы с партициями
   необходимо выполнить скрипты, начиная с [этого](/src/main/resources/db/migration/V28__add_paуment_partition.sql)
   и закачивая последним __partition_ скриптом.
3. После применения скриптов появится пустая партиционированная таблица с постфиксом _new - клон целевой таблицы.
4. Необходимо скопировать данные из целевой таблицы в новую партиционированную. Для этих данных
   предусмотрен процесс миграции в исторические партиции для новой созданной таблицы.
Пример для таблицы _dw.payment_:

    ```
    INSERT INTO payment_new SELECT * FROM payment;
    ```
   Надо учесть, что таблицы большие и необходим downtime для daway для копирвания данных.
5. После того как данные будут смигрированны, таблица _payment_ переименовывается в _payment_old_, а
   _payment_new_ в _payment_.

    ```
    ALTER TABLE dw.payment RENAME TO payment_old;
    ALTER TABLE dw.payment_new RENAME TO payment;
    ```

6. Делается небольшой сдвиг соответствующего offset в kafka для подгрузки данных, пришедших за время
   downtime, и вновь запускается daway.

## План отката

В случае каких либо проблем предусмотрен план отката.

1. Удаление новой таблицы

    ```
    DROP TABLE dw.payments_new.
    ```

2. Переименование payment в payment_new, а payment_old в payment. То есть обратный процесс.

После успешного завершения миграции удалить старую таблицу dw.payment_old. 

